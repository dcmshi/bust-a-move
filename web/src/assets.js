/**
 * assets.js
 * Preloads all images and audio. Paths are relative to index.html (web/).
 * Original BMP files live in ../assets/, MP3s in ../music/.
 *
 * Audio rename map (original → key used here):
 *   Hellogoodbye - Shimmy Shimmy Quarter Turn.mp3  → audio.intro
 *   The Postal Service - Such Great Heights.mp3     → audio.track1
 *   royksopp - Remind Me.mp3                        → audio.track2
 *   hellogoodbye - here (in your arms).mp3          → audio.track3
 *   Techno - Sand Storm.mp3                         → audio.track4
 *   Hot Hot Heat - Talk to Me, Dance With Me.mp3    → audio.win
 *   Plain White T's.mp3                             → audio.lose
 */

const IMAGE_MANIFEST = {
  // UI
  mainTitle:    '../assets/mainTitle.bmp',
  play:         'assets/play.png',
  what:         'assets/what.png',
  back:         'assets/back.png',
  instructions: '../assets/instructions.bmp',
  next:         'assets/next.png',
  man:          'assets/man.png',
  // Shooter + HUD sprites — transparent PNGs (generated by convert-assets.js)
  shooter:      'assets/shooter.png',
  gun:          'assets/gun.png',
  // Lives HUD
  life1:        '../assets/life1.bmp',
  life2:        '../assets/life2.bmp',
  life3:        '../assets/life3.bmp',
  // Backgrounds
  bg1:          '../assets/levelbackground.bmp',
  bg2:          '../assets/levelbackground2.bmp',
  bg3:          '../assets/levelbackground3.bmp',
  bg4:          '../assets/levelbackground4.bmp',
  // Game over screens
  gameover:     '../assets/gameover.bmp',
  gameover2:    '../assets/gameover2.bmp',
  // Bubbles — transparent PNGs (generated by convert-assets.js)
  bubble1:      'assets/bluebubble.png',
  bubble2:      'assets/greenbubble.png',
  bubble3:      'assets/greybubble.png',
  bubble4:      'assets/orangebubble.png',
  bubble5:      'assets/purplebubble.png',
  bubble6:      'assets/yellowbubble.png',
  bubble7:      'assets/redbubble.png',
  bubble8:      'assets/whitebubble.png',
};

const AUDIO_MANIFEST = {
  intro:   '../music/Hellogoodbye - Shimmy Shimmy Quarter Turn.mp3',
  track1:  '../music/The Postal Service - Such Great Heights.mp3',
  track2:  '../music/royksopp - Remind Me.mp3',
  track3:  '../music/hellogoodbye - here (in your arms).mp3',
  track4:  '../music/Techno - Sand Storm.mp3',
  win:     '../music/Hot Hot Heat - Talk to Me, Dance With Me.mp3',
  lose:    "../music/Plain White T's.mp3",
};

export const images = {};
export const audio  = {};

function loadImage(key, src) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload  = () => { images[key] = img; resolve(); };
    img.onerror = () => { console.warn(`[assets] missing: ${src}`); resolve(); };
    img.src = src;
  });
}


function loadAudio(key, src) {
  // Audio is non-blocking — browser autoplay policy means we can't verify
  // playback readiness until after the first user gesture anyway.
  const el = new Audio();
  el.preload = 'auto';
  el.loop    = false; // controlled by audio.js
  el.src     = src;
  audio[key] = el;
}

/**
 * Preload all assets. Calls onProgress(0–1) as images finish loading.
 * Audio elements are created immediately but not awaited.
 * @param {(progress: number) => void} [onProgress]
 */
export async function loadAll(onProgress) {
  const entries = Object.entries(IMAGE_MANIFEST);
  let loaded = 0;

  // Set up audio elements synchronously (no await needed)
  for (const [key, src] of Object.entries(AUDIO_MANIFEST)) {
    loadAudio(key, src);
  }

  // Await all images
  await Promise.all(
    entries.map(([key, src]) =>
      loadImage(key, src).then(() => {
        loaded++;
        onProgress?.(loaded / entries.length);
      })
    )
  );
}

/** Get bubble image by Turing colour ID (1–8). */
export function getBubbleImage(colourId) {
  return images[`bubble${colourId}`];
}

/**
 * Get background image for a given level (1–12).
 * Pattern mirrors the original: bg2, bg3, bg4, bg1, bg2, bg3, bg4, bg1 …
 */
export function getBackground(level) {
  const cycle = ['bg2', 'bg3', 'bg4', 'bg1'];
  return images[cycle[(level - 1) % 4]];
}
